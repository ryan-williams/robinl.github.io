(self.webpackChunkgatsby_starter_hello_world=self.webpackChunkgatsby_starter_hello_world||[]).push([[750],{2465:function(e,t,a){"use strict";function n(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}a.d(t,{Z:function(){return n}})},1369:function(e,t,a){"use strict";a.d(t,{Z:function(){return d}});a(7294);var n=a(835),r=a(674),o=(a(5713),a(5444));var i={name:"mh6tuh",styles:"margin-top:1rem;margin-bottom:0.5rem;"},s={name:"gg4vpm",styles:"display:flex;justify-content:space-between;"},l=["/intro_to_probabilistic_linkage/","/maths_of_fellegi_sunter/","/visualising_fellegi_sunter/","/understanding_match_weights/","/match_weight_dependencies/","/m_u_generator/"],m=function(e){var t=e.current_path,a=l.indexOf(t),n=l[a-1],m=l[a+1];return n=void 0===n?(0,r.tZ)("div",null):(0,r.tZ)("div",null,(0,r.tZ)(o.rU,{to:n}," < Previous article")),m=void 0===m?(0,r.tZ)("div",null):(0,r.tZ)("div",null,(0,r.tZ)(o.rU,{to:m}," Next article >")),(0,r.tZ)("div",null,(0,r.tZ)("hr",{css:i}),(0,r.tZ)("div",{css:s},n,(0,r.tZ)("div",null,(0,r.tZ)(o.rU,{to:"/probabilistic_linkage"},"Probabilistic linkage home")),m))},c=a(8847),u=a(7414),_=a(6140);var d=function(e){var t=(0,r.tZ)(c.Z,{define:e.define,output_order:e.output_order});return(0,r.tZ)(n.Z,{css:e.className},(0,r.tZ)(_.Z,{title:e.post_frontmatter.title,description:e.post_frontmatter.description}),(0,r.tZ)(u.Z,{post_frontmatter:e.post_frontmatter}),t,(0,r.tZ)(m,{current_path:e.current_path}))}},244:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return An},frontmatter:function(){return Sn}});a(7294);var n,r,o,i,s,l,m,c,u,_,d,f,p,b,h,v,g,y,w,x,k,P,Z,q,T,j,S,O,F,A,E,C,B,D,I,W,R,J,L,M,N,z,H,U,K,V,G,Y,$,Q,X,ee,te,ae,ne,re,oe,ie,se,le,me,ce,ue,_e,de,fe,pe,be,he,ve,ge,ye,we,xe,ke,Pe,Ze,qe,Te,je=a(2465),Se=a(6610),Oe=a(5991),Fe=a(6156),Ae=a(2137),Ee=a(7757),Ce=a.n(Ee);function Be(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function De(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Be(Object(a),!0).forEach((function(t){(0,Fe.Z)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Be(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function Ie(e){return e(n||(n=(0,je.Z)(['# Arquero\n\nArquero is a library for query processing and transformation of array-backed data tables. Following the [relational algebra](https://en.wikipedia.org/wiki/Relational_algebra) and inspired by the design of [dplyr](https://dplyr.tidyverse.org/), Arquero provides a fluent API for manipulating column-oriented data frames. Arquero supports a range of data transformation tasks, including filter, sample, aggregation, window, join, and reshaping operations. Arquero is Spanish for "archer": if datasets are [arrows](https://observablehq.com/@theneuralbit/introduction-to-apache-arrow), Arquero helps their aim stay true.'])))}function We(e){return e(r||(r=(0,je.Z)(["Import Arquero and extend it to print HTML tables in Observable:"])))}function Re(e,t,a,n){return Je.apply(this,arguments)}function Je(){return(Je=(0,Ae.Z)(Ce().mark((function e(t,a,n,r){var o;return Ce().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t("arquero@".concat(a));case 2:return o=e.sent,e.next=5,Promise.all(n.map((function(e){return t(e)})));case 5:return e.sent.forEach((function(e){return o.addPackage(e)})),o.addTableMethod("view",r,{override:!0}),e.abrupt("return",o);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Le(){return"4.2.0"}function Me(){return[]}function Ne(e){return e(o||(o=(0,je.Z)(["Export a global reference to Arquero operations:"])))}function ze(e){return e.op}function He(e){return e(i||(i=(0,je.Z)(["To use the same setup in your own notebooks, add a cell with the following code:\n~~~ js\nimport { aq, op } from '@uwdata/arquero'\n~~~\n"])))}function Ue(e){return e(s||(s=(0,je.Z)(["To get started, see the [Introducing Arquero](https://observablehq.com/@uwdata/introducing-arquero) and [Arquero Cookbook](https://observablehq.com/@uwdata/arquero-cookbook) notebooks."])))}function Ke(e){return e(l||(l=(0,je.Z)(["To use Arquero outside of Observable, see [https://github.com/uwdata/arquero](https://github.com/uwdata/arquero)."])))}function Ve(e){return e(m||(m=(0,je.Z)(["<hr>\n## Examples\n\nThe core abstractions in Arquero are *data tables*, which model each column as an array of values, and *verbs* that transform data and return new tables. Verbs are table methods, allowing method chaining for multi-step transformations. Though each table is unique, many verbs reuse the underlying columns to limit duplication.\n"])))}function Ge(e){return e(c||(c=(0,je.Z)(["Average hours of sunshine per month, from [https://usclimatedata.com/](https://usclimatedata.com/):"])))}function Ye(e){return e.table({Seattle:[69,108,178,207,253,268,312,281,221,142,72,52],Chicago:[135,136,187,215,281,311,318,283,226,193,113,106],"San Francisco":[165,182,251,281,314,330,300,272,267,243,189,156]})}function $e(e){return e(u||(u=(0,je.Z)(["Sorted differences between Seattle and Chicago:"])))}function Qe(e,t){return e.derive({month:function(e){return t.row_number()},diff:function(e){return e.Seattle-e.Chicago}}).select("month","diff").orderby("month").view({height:400})}function Xe(e){return e(_||(_=(0,je.Z)(["Is Seattle more correlated with San Francisco or Chicago?"])))}function et(e,t){return e.rollup({corr_sf:t.corr("Seattle","San Francisco"),corr_chi:t.corr("Seattle","Chicago")}).view()}function tt(e){return e(d||(d=(0,je.Z)(["Summary statistics per city, as output objects:"])))}function at(e,t,a){return e.fold(t.all(),{as:["city","sun"]}).groupby("city").rollup({min:function(e){return a.min(e.sun)},max:function(e){return a.max(e.sun)},avg:function(e){return a.average(e.sun)},med:function(e){return a.median(e.sun)},skew:function(e){var t=e.sun;return(a.mean(t)-a.median(t))/a.stdev(t)||0}}).objects()}function nt(e){return e(f||(f=(0,je.Z)(["<hr>\n## Utilities\n"])))}function rt(e){var t=function(e){return'<span style="color: #999;">'.concat(e,"</span>")},a="margin: 0; border-collapse: collapse; width: initial;",n="padding: 1px 5px; white-space: nowrap; overflow-x: hidden; text-overflow: ellipsis; font-variant-numeric: tabular-nums;";return function(r){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};"number"==typeof o&&(o={limit:o});var i=De({},o.color);if("function"==typeof o.color)r.columnNames().forEach((function(e){return i[e]=o.color}));else{var s=function(e){var t=i[e];i[e]="function"==typeof t?t:function(){return t}};for(var l in i)s(l)}var m="".concat(a),c=function(e,t,a){return"".concat(n," max-width: ").concat(+o.maxCellWidth||300,"px;")+(i[e]?" background-color: ".concat(i[e](t,a),";"):"")};o=De(De({limit:100,null:t},o),{},{style:{table:m,td:c,th:c}});var u="max-height: ".concat(+o.height||270,"px"),_="".concat(u,"; overflow-x: auto; overflow-y: auto;"),d=e(p||(p=(0,je.Z)(['<div style="','">',"</div>"])),_,r.toHTML(o));return d.value=r,d}}function ot(e,t){var a=e.module();return a.variable(t()).define(["md"],Ie),a.variable(t()).define(["md"],We),a.variable(t("aq")).define("aq",["require","aq_version","aq_packages","toView"],Re),a.variable(t("aq_version")).define("aq_version",Le),a.variable(t("aq_packages")).define("aq_packages",Me),a.variable(t()).define(["md"],Ne),a.variable(t("op")).define("op",["aq"],ze),a.variable(t()).define(["md"],He),a.variable(t()).define(["md"],Ue),a.variable(t()).define(["md"],Ke),a.variable(t()).define(["md"],Ve),a.variable(t()).define(["md"],Ge),a.variable(t("dt")).define("dt",["aq"],Ye),a.variable(t()).define(["md"],$e),a.variable(t()).define(["dt","op"],Qe),a.variable(t()).define(["md"],Xe),a.variable(t()).define(["dt","op"],et),a.variable(t()).define(["md"],tt),a.variable(t()).define(["dt","aq","op"],at),a.variable(t()).define(["md"],nt),a.variable(t("toView")).define("toView",["html"],rt),a}function it(e){return e(b||(b=(0,je.Z)(["# Record Utilities"])))}function st(e){return function(){function t(e){(0,Se.Z)(this,t),this.record_dict=e}return(0,Oe.Z)(t,[{key:"as_dict",value:function(){return this.record_dict}},{key:"as_aq",value:function(){return e.from([this.record_dict])}},{key:"display",value:function(){return this.as_aq().view()}}]),t}()}function lt(e){return function(){function t(e,a){(0,Se.Z)(this,t),this.record_l=e,this.record_r=a}return(0,Oe.Z)(t,[{key:"as_long",value:function(){var t=[this.record_l.as_dict(),this.record_r.as_dict()];return e.from(t)}},{key:"as_wide",value:function(){var e=this.record_l.as_aq(),t=this.record_r.as_aq(),a=e.join(t,(function(e,t){return!0}),null,{suffix:["_l","_r"]}),n=e.columnNames(),r=[];return n.forEach((function(e){r.push(e+"_l"),r.push(e+"_r")})),a=a.select(r)}},{key:"display",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"long";return"long"==e?this.as_long().view():"wide"==e?this.as_wide().view():void 0}}]),t}()}function mt(e,t){var a=e.module();a.variable(t()).define(["md"],it),a.variable(t("Record")).define("Record",["aq"],st),a.variable(t("RecordComparison")).define("RecordComparison",["aq"],lt);var n=e.module(ot);return a.import("aq",n),a.import("op",n),a}function ct(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function ut(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ct(Object(a),!0).forEach((function(t){(0,Fe.Z)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ct(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function _t(e){return e(h||(h=(0,je.Z)(["# Waterfall chart"])))}function dt(e){return e(v||(v=(0,je.Z)(["### Objective\n\nTake \n- a Splink settings object \n- A row of data from `df_e`\nAnd turn it into the data needed for the waterfall chart.\n\n"],["### Objective\n\nTake \n- a Splink settings object \n- A row of data from \\`df_e\\`\nAnd turn it into the data needed for the waterfall chart.\n\n"])))}function ft(e){return e(g||(g=(0,je.Z)(["## Example"])))}function pt(){return{proportion_of_matches:.01,comparison_columns:[{num_levels:3,col_name:"first_name",u_probabilities:[.8,.2],m_probabilities:[.2,.8]},{num_levels:3,col_name:"surname",u_probabilities:[.8,.2],m_probabilities:[.2,.8]},{col_name:"date_of_birth",u_probabilities:[.99,.01],m_probabilities:[.2,.8]}]}}function bt(){var e;return e={first_name_l:"John",first_name_r:"John","𝛾_first_name":1,surname_l:"Smith",surname_r:"Smith","𝛾_surname":1,date_of_birth_l:"1992-04-01"},(0,Fe.Z)(e,"date_of_birth_l","1992-04-02"),(0,Fe.Z)(e,"𝛾_date_of_birth",0),(0,Fe.Z)(e,"other","hi"),e}function ht(){return{height:200}}function vt(e,t,a,n){return e(t,a,n,!0)}function gt(e,t,a,n){return e(t,a,n,!1)}function yt(e){return e(y||(y=(0,je.Z)(["## Code"])))}function wt(e,t,a){return function(n,r,o,i){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},l=e(n,r,s);return t(a(l,o,i))}}function xt(){return function(e){var t={};return e.comparison_columns.forEach((function(e){var a=e.col_name;t[a]=e})),t}}function kt(e,t,a){return function(n,r){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=e(r),s=t(n,r,o),l=[i].concat(s),m=a(r),c=l.reduce((function(e,t){return e+t.log2_bayes_factor}),0);return m.bayes_factor=Math.pow(2,c),m.log2_bayes_factor=c,l.concat([m])}}function Pt(e,t){return function(a,n,r,o){var i,s,l=a,m=n[l],c=l.replace("𝛾_",""),u=e(r)[c],_=n[c+"_l"],d=n[c+"_r"];-1==m?(i=.5,s=.5):(i=u.u_probabilities[m],s=u.m_probabilities[m],_==d&&c in o&&(i=o[c][_]||i));var f=s/i;return{bayes_factor:f,column_name:c,gamma_column_name:"𝛾_"+c,gamma_index:m,level_name:"level_"+m,log2_bayes_factor:t(f),m_probability:s,num_levels:null,u_probability:i,value_l:_,value_r:d}}}function Zt(e,t){return function(a){return{bayes_factor:e(a.proportion_of_matches),column_name:"Prior",gamma_column_name:"",gamma_index:"",level_name:null,log2_bayes_factor:t(a.proportion_of_matches),m_probability:null,num_levels:null,u_probability:null,value_l:"",value_r:""}}}function qt(e){return function(t,a,n){var r=Object.keys(t);return(r=r.filter((function(e){return e.includes("𝛾_")}))).map((function(r){return e(r,t,a,n)}))}}function Tt(){return function(e){return{bayes_factor:null,column_name:"Final score",gamma_column_name:"",gamma_index:"",level_name:null,log2_bayes_factor:null,m_probability:null,num_levels:null,u_probability:null,value_l:"",value_r:""}}}function jt(e){return function(t,a){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=JSON.parse(JSON.stringify(e));r.data.values=t;var o=ut(ut({},r),a);if(n){o.layer[1].encoding.y.axis=!1,o.layer[0].layer[2].encoding.text={type:"nominal",field:"up_down_emoji"},o.layer[0].layer[2].encoding.opacity={condition:{value:0,test:"datum.column_name == 'Final score' || datum.column_name == 'Prior'"}};var i="format(1 / (1 + pow(2, -1*datum.value)), '.2r')";o.layer[0].layer[1].encoding.y.axis.labelExpr=i,o.layer[0].layer[1].encoding.y.axis.title="probability",o.layer[0].layer[1].encoding.tooltip=[{type:"quantitative",field:"prob",format:".3r",title:"Cumulative match probability"}]}return o}}function St(){return{config:{view:{continuousHeight:300,continuousWidth:400}},title:{text:"Bayes factor intuition chart",subtitle:"How each comparison column contributes to the final match score"},transform:[{filter:"(datum.bayes_factor !== 1.0)"},{window:[{op:"sum",field:"log2_bayes_factor",as:"sum"},{op:"lead",field:"column_name",as:"lead"}],frame:[null,0]},{calculate:'datum.column_name === "Final score" ? datum.sum - datum.log2_bayes_factor : datum.sum',as:"sum"},{calculate:"datum.lead === null ? datum.column_name : datum.lead",as:"lead"},{calculate:'datum.column_name === "Final score" || datum.column_name === "Prior lambda" ? 0 : datum.sum - datum.log2_bayes_factor',as:"previous_sum"},{calculate:'datum.sum > datum.previous_sum ? datum.column_name : ""',as:"top_label"},{calculate:'datum.sum < datum.previous_sum ? datum.column_name : ""',as:"bottom_label"},{calculate:"datum.sum > datum.previous_sum ? datum.sum : datum.previous_sum",as:"sum_top"},{calculate:"datum.sum < datum.previous_sum ? datum.sum : datum.previous_sum",as:"sum_bottom"},{calculate:"(datum.sum + datum.previous_sum) / 2",as:"center"},{calculate:'(datum.log2_bayes_factor > 0 ? "+" : "") + datum.log2_bayes_factor',as:"text_log2_bayes_factor"},{calculate:"datum.sum < datum.previous_sum ? 4 : -4",as:"dy"},{calculate:'datum.sum < datum.previous_sum ? "top" : "bottom"',as:"baseline"},{calculate:"1. / (1 + pow(2, -1.*datum.sum))",as:"prob"},{calculate:"0*datum.sum",as:"zero"},{calculate:'datum.sum > datum.previous_sum ? "↑" : "↓"',as:"up_down_emoji"}],layer:[{layer:[{mark:"rule",encoding:{y:{field:"zero",type:"quantitative"},size:{value:.5},color:{value:"black"}}},{mark:{type:"bar",width:60},encoding:{color:{condition:{value:"red",test:"(datum.log2_bayes_factor < 0)"},value:"green"},opacity:{condition:{value:1,test:"datum.column_name == 'Prior' || datum.column_name == 'Final score'"},value:.5},tooltip:[{type:"nominal",field:"column_name",title:"Comparison column"},{type:"nominal",field:"value_l",title:"Value (L)"},{type:"nominal",field:"value_r",title:"Value (R)"},{type:"nominal",field:"gamma_index",title:"Gamma level"},{type:"quantitative",field:"bayes_factor",format:".3r",title:"Bayes factor"},{type:"quantitative",field:"log2_bayes_factor",format:".3r",title:"log2(Bayes factor)"},{type:"quantitative",field:"prob",format:".3r",title:"Cumulative match probability"}],x:{type:"nominal",axis:{labelExpr:"datum.value == 'Prior' || datum.value == 'Final score' ? '' : datum.value",labelAlign:"center",labelPadding:10,title:"Column",grid:!0,tickBand:"extent"},field:"column_name",sort:null},y:{type:"quantitative",axis:{grid:!1,orient:"left",title:"log2(Bayes factor)"},field:"previous_sum"},y2:{field:"sum"}}},{mark:{type:"text",fontWeight:"bold"},encoding:{color:{value:"white"},text:{condition:{type:"nominal",field:"log2_bayes_factor",format:".2f",test:"abs(datum.log2_bayes_factor) > 1"},value:""},x:{type:"nominal",axis:{labelAngle:0,title:"Column"},field:"column_name",sort:null},y:{type:"quantitative",axis:{orient:"left"},field:"center"}}},{mark:{type:"text",baseline:"bottom",dy:-5,fontWeight:"bold"},encoding:{color:{value:"black"},text:{condition:{type:"nominal",field:"top_label",test:"abs(datum.log2_bayes_factor) > 1"},value:""},x:{type:"nominal",axis:{labelAngle:0,title:"Column"},field:"column_name",sort:null},y:{type:"quantitative",field:"sum_top"}}},{mark:{type:"text",baseline:"top",dy:5,fontWeight:"bold"},encoding:{color:{value:"black"},text:{condition:{type:"nominal",field:"bottom_label",test:"abs(datum.log2_bayes_factor) > 1"},value:""},x:{type:"nominal",axis:{labelAngle:0,title:"Column"},field:"column_name",sort:null},y:{type:"quantitative",field:"sum_bottom"}}}]},{mark:{type:"rule",color:"black",strokeWidth:2,x2Offset:30,xOffset:-30},encoding:{x:{type:"nominal",axis:{labelAngle:0,title:"Column"},field:"column_name",sort:null},x2:{field:"lead"},y:{type:"quantitative",axis:{labelExpr:"format(1 / (1 + pow(2, -1*datum.value)), '.2r')",orient:"right",title:"Probability"},field:"sum",scale:{zero:!1}}}}],height:450,resolve:{axis:{y:"independent"}},width:{step:75},$schema:"https://vega.github.io/schema/vega-lite/v4.8.1.json",data:{values:null}}}function Ot(e){return e("vega-embed@6")}function Ft(){return function(e){return e/(e+1)}}function At(){return Math.log2}function Et(){return function(e){return e/(1-e)}}function Ct(e,t){return function(a){return e(t(a))}}function Bt(e){return function(t){return e(Math.pow(2,t))}}function Dt(e){return e.csv("https://gist.githubusercontent.com/RobinL/0ee2e59db8cbecc105942fe4b101e847/raw/110e5bb3b574b7584b5452d4accfcfad71f2b19d/first_name_noyear.csv",e.autoType).then((function(e){var t={};return e.forEach((function(e){t[e.firstname]=e.freq})),t}))}function It(e){return{first_name:e}}function Wt(e,t){var a=e.module();return a.variable(t()).define(["md"],_t),a.variable(t()).define(["md"],dt),a.variable(t()).define(["md"],ft),a.variable(t("splink_settings")).define("splink_settings",pt),a.variable(t("row")).define("row",bt),a.variable(t("overrides")).define("overrides",ht),a.variable(t()).define(["get_waterfall_chart","row","splink_settings","overrides"],vt),a.variable(t()).define(["get_waterfall_chart","row","splink_settings","overrides"],gt),a.variable(t()).define(["md"],yt),a.variable(t("get_waterfall_chart")).define("get_waterfall_chart",["get_waterfall_chart_data","embed","get_chart_spec"],wt),a.variable(t("get_comparison_column_lookup")).define("get_comparison_column_lookup",xt),a.variable(t("get_waterfall_chart_data")).define("get_waterfall_chart_data",["get_waterfall_data_lambda_row","get_waterfall_data_other_rows","get_waterfall_data_final_row"],kt),a.variable(t("get_waterfall_row_gamma")).define("get_waterfall_row_gamma",["get_comparison_column_lookup","log2"],Pt),a.variable(t("get_waterfall_data_lambda_row")).define("get_waterfall_data_lambda_row",["prob_to_bayes_factor","prob_to_log2_bayes_factor"],Zt),a.variable(t("get_waterfall_data_other_rows")).define("get_waterfall_data_other_rows",["get_waterfall_row_gamma"],qt),a.variable(t("get_waterfall_data_final_row")).define("get_waterfall_data_final_row",Tt),a.variable(t("get_chart_spec")).define("get_chart_spec",["base_spec"],jt),a.variable(t("base_spec")).define("base_spec",St),a.variable(t("embed")).define("embed",["require"],Ot),a.variable(t("bayes_factor_to_prob")).define("bayes_factor_to_prob",Ft),a.variable(t("log2")).define("log2",At),a.variable(t("prob_to_bayes_factor")).define("prob_to_bayes_factor",Et),a.variable(t("prob_to_log2_bayes_factor")).define("prob_to_log2_bayes_factor",["log2","prob_to_bayes_factor"],Ct),a.variable(t("log2_bayes_factor_to_prob")).define("log2_bayes_factor_to_prob",["bayes_factor_to_prob"],Bt),a.variable(t("first_name_lookup")).define("first_name_lookup",["d3"],Dt),a.variable(t("term_freqs")).define("term_freqs",["first_name_lookup"],It),a}function Rt(e){return e(w||(w=(0,je.Z)(["# Fellegi Sunter utils"])))}function Jt(){return[{uid:"1_l",fname:"John",sname:"Smith",dob:"1989-03-02",town:"Bristol"},{uid:"2_l",fname:"Tom",sname:"Hanks",dob:"1956-07-09",town:"Concord"},{uid:"3_l",fname:"David",sname:"Smith",dob:"1981-08-21",town:"London"}]}function Lt(){return[{uid:"1_r",fname:"Jonathan",sname:"Smith",dob:"1989-03-02",town:"Bristol"},{uid:"2_r",fname:"David",sname:"Smith",dob:"1981-08-21",town:"Peckham"}]}function Mt(e,t){return e.from(t)}function Nt(){return{proportion_of_matches:.01,comparison_columns:[{num_levels:3,col_name:"fname",u_probabilities:[.8,.2],m_probabilities:[.2,.8],case_expression:function(e){return e.fname_l==e.fname_r?1:0}},{num_levels:3,col_name:"sname",u_probabilities:[.9,.1],m_probabilities:[.2,.8],case_expression:function(e){return e.sname_l==e.sname_r?1:0}},{col_name:"dob",u_probabilities:[.99,.01],m_probabilities:[.2,.8],case_expression:function(e){return e.dob_l==e.dob_r?1:0}},{col_name:"town",u_probabilities:[.7,.3],m_probabilities:[.3,.7],case_expression:function(e){return e.town_l==e.town_r?1:0}}]}}function zt(e,t,a){return e(t,a)}function Ht(e){return e.view()}function Ut(e,t,a){return e(t,a)}function Kt(e){return e.view()}function Vt(e,t,a,n){return e(t,a,n).view()}function Gt(e,t){return function(a,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=a.objects().map((function(t){return t.match_probability=e(t,n,r),t})),i=t.from(o);return i=i.relocate(["match_probability"],{after:"uid_r"})}}function Yt(e,t){return function(a,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=n.comparison_columns,i=e(n.proportion_of_matches),s=o.reduce((function(e,t){var n="𝛾_"+t.col_name,o=a[n];if(-1==o)return e;var i=t.m_probabilities[o],s=t.u_probabilities[o],l=a[t.col_name+"_l"].toLowerCase(),m=a[t.col_name+"_r"].toLowerCase();if(l==m&&t.col_name in r){var c=r[t.col_name],u=c[l]||0,_=c[m]||0,d=Math.max(u,_);d>0&&(s=d)}return e+Math.log2(i/s)}),i);return t(s)}}function $t(e,t){return function(a,n,r){null==r&&(r=n.comparison_columns.length);var o=n.comparison_columns.slice(0,r),i=e(n.proportion_of_matches),s={comparison_vector:[],gamma_symbols:[],m_values:[],u_values:[],m_symbols:[],u_symbols:[],bayes_factors:[],log2_bayes_factors:[],col_names:[],match_probability:null,lam:n.proportion_of_matches};o.forEach((function(e){var t="𝛾_"+e.col_name,n=a[t],r=e.m_probabilities[n],o=e.u_probabilities[n],i=e.col_name.replace("_","\\_");s.comparison_vector.push(n),s.gamma_symbols.push("\\gamma_\\text{".concat(i,"}")),s.col_names.push(t),s.m_values.push(r),s.m_symbols.push("m_{\\text{".concat(i,"},").concat(n,"}")),s.u_values.push(o),s.u_symbols.push("u_{\\text{".concat(i,"},").concat(n,"}")),s.bayes_factors.push(r/o),s.log2_bayes_factors.push(Math.log2(r/o))}));var l=s.log2_bayes_factors.reduce((function(e,t){return e+t}),i);s.match_probability=t(l);var m=n.proportion_of_matches;return s.size_of_match_portion=m*s.m_values.reduce((function(e,t){return e*t}),1),s.size_of_non_match_portion=(1-m)*s.u_values.reduce((function(e,t){return e*t}),1),s}}function Qt(e){return function(t,a,n){var r=e(t,a,n),o=r.m_values.map((function(e){return e.toPrecision(3)})),i=r.u_values.map((function(e){return e.toPrecision(3)})),s=r.lam.toPrecision(3),l=[s].concat(o),m=["(1 - ".concat(s,")")].concat(i),c=l.join(" \\times "),u=m.join(" \\times "),_=r.match_probability.toPrecision(3),d=r.size_of_match_portion.toPrecision(3),f=r.size_of_non_match_portion.toPrecision(3);return"\\frac{".concat(c,"}{(").concat(c,") + (").concat(u,")}  \\newline[10pt] = \\frac{").concat(d,"}{").concat(d," + ").concat(f,"}  \\newline[10pt] = ").concat(_)}}function Xt(e){return function(t,a){var n=e(t,a),r=n.m_symbols,o=n.u_symbols,i=(n.lam,["\\lambda"].concat(r)),s=["(1 - \\lambda)"].concat(o),l=i.join(" "),m=s.join(" ");return"\\frac{".concat(l,"}{").concat(l,") + ").concat(m,"}")}}function ea(e,t,a,n){return e(x||(x=(0,je.Z)(["","\n"])),t(a.objects()[0],n))}function ta(e){return function(t,a,n){var r=e(t,a,n),o=r.gamma_symbols.join(", "),i=r.comparison_vector.join(", ");return"\\bm{\\gamma} = [".concat(o,"]= [").concat(i,"]")}}function aa(e,t,a,n){return e(k||(k=(0,je.Z)(["","\n"])),t(a.objects()[0],n))}function na(e){return e(P||(P=(0,je.Z)(["\bm{gamma} = [gamma_\text{fname}, gamma_\text{sname}]"],["\\bm{\\gamma} = [\\gamma_\\text{fname}, \\gamma_\\text{sname}]"])))}function ra(e,t,a,n){return e(Z||(Z=(0,je.Z)(["",""])),t(a.objects()[0],n))}function oa(e,t,a){return e(t.objects()[0],a)}function ia(e){return function(t,a){var n=e.from(t),r=e.from(a),o=n.join(r,(function(e,t){return!0}),null,{suffix:["_l","_r"]}),i=n.columnNames(),s=[];return i.forEach((function(e){s.push(e+"_l"),s.push(e+"_r")})),o=o.select(s)}}function sa(e){return function(t,a){var n=a.comparison_columns,r=t.objects();n.forEach((function(e){r.forEach((function(t){t["𝛾_"+e.col_name]=e.case_expression(t)}))})),r=e.from(r);var o=["uid_l","uid_r"];return n.forEach((function(e){o.push(e.col_name+"_l"),o.push(e.col_name+"_r"),o.push("𝛾_"+e.col_name)})),r=r.select(o)}}function la(){return function(e){return e/(e+1)}}function ma(e){return function(t){return e(Math.pow(2,t))}}function ca(){return function(e){return e/(1-e)}}function ua(e){return function(t){return Math.log2(e(t))}}function _a(e){return e.csv("https://gist.githubusercontent.com/RobinL/0ee2e59db8cbecc105942fe4b101e847/raw/110e5bb3b574b7584b5452d4accfcfad71f2b19d/first_name_noyear.csv",e.autoType).then((function(e){var t={};return e.forEach((function(e){t[e.firstname]=e.freq})),t}))}function da(e){return e.csv("https://gist.githubusercontent.com/RobinL/0ee2e59db8cbecc105942fe4b101e847/raw/110e5bb3b574b7584b5452d4accfcfad71f2b19d/last_name.csv",e.autoType).then((function(e){var t={};return e.forEach((function(e){t[e.surname]=e.freq})),t}))}function fa(e,t){return{fname:e,sname:t}}function pa(e){return e.fname.joshua}function ba(e){return e.sname.linacre}function ha(e,t){var a=e.module();a.variable(t()).define(["md"],Rt),a.variable(t("records_l")).define("records_l",Jt),a.variable(t("records_r")).define("records_r",Lt),a.variable(t("df_r")).define("df_r",["aq","records_r"],Mt),a.variable(t("splink_settings")).define("splink_settings",Nt),a.variable(t("df_comparison")).define("df_comparison",["get_df_comparison","records_l","records_r"],zt),a.variable(t()).define(["df_comparison"],Ht),a.variable(t("df_gammas")).define("df_gammas",["get_df_gammas","df_comparison","splink_settings"],Ut),a.variable(t()).define(["df_gammas"],Kt),a.variable(t()).define(["get_df_e","df_gammas","splink_settings","term_freqs"],Vt),a.variable(t("get_df_e")).define("get_df_e",["get_match_probability","aq"],Gt),a.variable(t("get_match_probability")).define("get_match_probability",["prob_to_log2_bf","log2_bf_to_prob"],Yt),a.variable(t("get_match_probability_components")).define("get_match_probability_components",["prob_to_log2_bf","log2_bf_to_prob"],$t),a.variable(t("get_m_u_formula_numbers")).define("get_m_u_formula_numbers",["get_match_probability_components"],Qt),a.variable(t("get_m_u_formula_symbols")).define("get_m_u_formula_symbols",["get_match_probability_components"],Xt),a.variable(t()).define(["tex","get_m_u_formula_symbols","df_gammas","splink_settings"],ea),a.variable(t("get_comparison_vector_symbols_and_numbers")).define("get_comparison_vector_symbols_and_numbers",["get_match_probability_components"],ta),a.variable(t()).define(["tex","get_comparison_vector_symbols_and_numbers","df_gammas","splink_settings"],aa),a.variable(t()).define(["tex"],na),a.variable(t()).define(["tex","get_m_u_formula_numbers","df_gammas","splink_settings"],ra),a.variable(t()).define(["get_match_probability_components","df_gammas","splink_settings"],oa),a.variable(t("get_df_comparison")).define("get_df_comparison",["aq"],ia),a.variable(t("get_df_gammas")).define("get_df_gammas",["aq"],sa),a.variable(t("bayes_factor_to_prob")).define("bayes_factor_to_prob",la),a.variable(t("log2_bf_to_prob")).define("log2_bf_to_prob",["bayes_factor_to_prob"],ma),a.variable(t("prob_to_bayes_factor")).define("prob_to_bayes_factor",ca),a.variable(t("prob_to_log2_bf")).define("prob_to_log2_bf",["prob_to_bayes_factor"],ua);var n=e.module(ot);return a.import("aq",n),a.import("op",n),a.variable(t("first_name_lookup")).define("first_name_lookup",["d3"],_a),a.variable(t("surname_lookup")).define("surname_lookup",["d3"],da),a.variable(t("term_freqs")).define("term_freqs",["first_name_lookup","surname_lookup"],fa),a.variable(t()).define(["term_freqs"],pa),a.variable(t()).define(["term_freqs"],ba),a}function va(e,t){var a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=function(e,t){if(!e)return;if("string"==typeof e)return ga(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(e);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return ga(e,t)}(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var n=0,r=function(){};return{s:r,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==a.return||a.return()}finally{if(s)throw o}}}}function ga(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function ya(e){return e(q||(q=(0,je.Z)(["# Charts and Figures (Introduction)"])))}function wa(e){return new e({first_name:"John",surname:"Smith",date_of_birth:"1989-03-02",town:"Bristol"})}function xa(e){return new e({first_name:"John",surname:"Smith",date_of_birth:"1989-03-02",town:"Bath"})}function ka(e,t,a){return new e(t,a)}function Pa(){return{proportion_of_matches:.01,comparison_columns:[{num_levels:3,col_name:"first_name",u_probabilities:[.8,.2],m_probabilities:[.2,.8]},{num_levels:3,col_name:"surname",u_probabilities:[.9,.1],m_probabilities:[.2,.8]},{col_name:"date_of_birth",u_probabilities:[.99,.01],m_probabilities:[.2,.8]},{col_name:"town",u_probabilities:[.7,.3],m_probabilities:[.3,.7]}]}}function Za(e,t){var a=e.as_wide().objects()[0];return Object.keys(t.as_dict()).forEach((function(e){a[e+"_l"]==a[e+"_r"]?a["𝛾_"+e]=1:a["𝛾_"+e]=0})),a}function qa(){return{title:{text:"Match weights and their cumulative contribution to match probability",subtitle:""},height:200}}function Ta(e,t,a,n){return e(t,a,n,!0)}function ja(e){return e(T||(T=(0,je.Z)(["# Charts and Figures (Mathematical Model)"])))}function Sa(){return function(e){var t=[],a={"unique id":"uid","first name":"fname",surname:"sname","date of birth":"dob",town:"town"};return e.querySelectorAll("tr").forEach((function(e,a){var n,r=[],o=va(e.cells);try{for(o.s();!(n=o.n()).done;){var i=n.value.innerText;""==(i=(i=i.trim()).toLowerCase())&&(i=null),r.push(i)}}catch(s){o.e(s)}finally{o.f()}t.push(r)})),t.reduce((function(e,t,n){if(0==n)t=t.map((function(e){return a[e]})),e.properties=t;else{var r={};e.properties.forEach((function(e,a){r[e]=t[a]})),e.push(r)}return e}),[])}}function Oa(e,t,a){return e.observe((function(e){var n=function(n){return e(t(a))};return a.addEventListener("input",n,!1),e(t(a)),function(){return window.removeEventListener("input",n)}}))}function Fa(e){return e(j||(j=(0,je.Z)(['\n<table id="data-table" >\n\n<tr>\n\n<th>Unique ID</th>\n<th>First name</th>\n<th>Surname</th>\n<th>Date of Birth</th>\n<th>Town</th>\n\n</tr>\n\n<tr>\n<td>1_l</td>\n<td contenteditable>John</td>\n\n<td contenteditable>Smith</td>\n<td contenteditable>1989-03-02</td>\n<td contenteditable>Bristol</td>\n\n</tr>\n\n\n<tr>\n<td>2_l</td>\n<td contenteditable>Emma</td>\n\n<td contenteditable>Jones</td>\n<td contenteditable>1956-07-09</td>\n<td contenteditable>Hull</td>\n\n</tr>\n\n\n<tr>\n<td>3_l</td>\n<td contenteditable>David</td>\n\n<td contenteditable>Smith</td>\n<td contenteditable>1981-08-21</td>\n<td contenteditable>London</td>\n\n</tr>\n\n\n</table>\n'])))}function Aa(e){return e(S||(S=(0,je.Z)(['\n<table id="data-table" >\n\n<tr>\n\n<th>Unique ID</th>\n<th>First name</th>\n<th>Surname</th>\n<th>Date of Birth</th>\n<th>Town</th>\n\n</tr>\n\n<tr>\n<td>1_l</td>\n<td contenteditable>Jonathan</td>\n\n<td contenteditable>Smith</td>\n<td contenteditable>1989-03-02</td>\n<td contenteditable>Bristol</td>\n\n</tr>\n\n\n<tr>\n<td>2_l</td>\n<td contenteditable>David</td>\n\n<td contenteditable>Smith</td>\n<td contenteditable>1981-08-21</td>\n<td contenteditable>Peckham</td>\n\n</tr>\n\n\n\n\n\n</table>\n'])))}function Ea(e,t,a){return e.observe((function(e){var n=function(n){return e(t(a))};return a.addEventListener("input",n,!1),e(t(a)),function(){return window.removeEventListener("input",n)}}))}function Ca(e,t){return e.from(t)}function Ba(e,t){return e.from(t)}function Da(e,t,a){return e(t,a)}function Ia(e,t,a){return e(t,a)}function Wa(e){var t=e.columnNames();return t=t.filter((function(e){return e.includes("𝛾_")})),t=["uid_l","uid_r"].concat(t),e.select(t)}function Ra(){return{proportion_of_matches:.01,comparison_columns:[{num_levels:3,col_name:"fname",u_probabilities:[.8,.2],m_probabilities:[.2,.8],case_expression:function(e){return e.fname_l==e.fname_r?1:0}},{num_levels:3,col_name:"sname",u_probabilities:[.9,.1],m_probabilities:[.2,.8],case_expression:function(e){return e.sname_l==e.sname_r?1:0}},{col_name:"dob",u_probabilities:[.99,.01],m_probabilities:[.2,.8],case_expression:function(e){return e.dob_l==e.dob_r?1:0}},{col_name:"town",u_probabilities:[.7,.3],m_probabilities:[.3,.7],case_expression:function(e){return e.town_l==e.town_r?1:0}}]}}function Ja(e){return new e({first_name:"Tom",surname:"Hanks",month_of_birth:"July"})}function La(e){return new e({first_name:"Tom",surname:"Hanks",month_of_birth:"June"})}function Ma(e,t,a){return new e(t,a)}function Na(e,t){var a=e.module();a.variable(t()).define(["md"],ya);var n=e.module(mt);a.import("Record",n),a.import("RecordComparison",n);var r=e.module(Wt);a.import("get_waterfall_chart",r),a.variable(t("example_record_1_l")).define("example_record_1_l",["Record"],wa),a.variable(t("example_record_1_r")).define("example_record_1_r",["Record"],xa),a.variable(t("example_1_comparison")).define("example_1_comparison",["RecordComparison","example_record_1_l","example_record_1_r"],ka),a.variable(t("splink_settings")).define("splink_settings",Pa),a.variable(t("example_1_row_with_gammas")).define("example_1_row_with_gammas",["example_1_comparison","example_record_1_l"],Za),a.variable(t("overrides")).define("overrides",qa),a.variable(t("intro_simple_waterfall")).define("intro_simple_waterfall",["get_waterfall_chart","example_1_row_with_gammas","splink_settings","overrides"],Ta),a.variable(t()).define(["md"],ja);var o=e.module(ha);a.import("get_df_comparison",o),a.import("get_df_gammas",o),a.variable(t("parseTableData")).define("parseTableData",Sa),a.variable(t("records_l")).define("records_l",["Generators","parseTableData","table_l"],Oa),a.variable(t("table_l")).define("table_l",["html"],Fa),a.variable(t("table_r")).define("table_r",["html"],Aa),a.variable(t("records_r")).define("records_r",["Generators","parseTableData","table_r"],Ea),a.variable(t("df_1_l")).define("df_1_l",["aq","records_l"],Ca),a.variable(t("df_1_r")).define("df_1_r",["aq","records_r"],Ba),a.variable(t("df_comparisons_1")).define("df_comparisons_1",["get_df_comparison","records_l","records_r"],Da),a.variable(t("df_gammas_1")).define("df_gammas_1",["get_df_gammas","df_comparisons_1","splink_settings_1"],Ia),a.variable(t("df_gammas_only_1")).define("df_gammas_only_1",["df_gammas_1"],Wa),a.variable(t("splink_settings_1")).define("splink_settings_1",Ra),a.variable(t("example_record_2_l")).define("example_record_2_l",["Record"],Ja),a.variable(t("example_record_2_r")).define("example_record_2_r",["Record"],La),a.variable(t("example_2_comparison")).define("example_2_comparison",["RecordComparison","example_record_2_l","example_record_2_r"],Ma);var i=e.module(ot);return a.import("aq",i),a.import("op",i),a}function za(e){return e(O||(O=(0,je.Z)(["# The mathematics of the Fellegi Sunter model"])))}function Ha(e){return e(F||(F=(0,je.Z)(["*A final version of this notebook can be viewed on my blog [here](https://www.robinlinacre.com/maths_of_fellegi_sunter/).*"])))}function Ua(e){return e(A||(A=(0,je.Z)(["In this article, we present an implementation of [Fellegi and Sunter's model of probabilistic record linkage](https://courses.cs.washington.edu/courses/cse590q/04au/papers/Felligi69.pdf) (1969).  \n\nWe build up a simple Fellegi Sunter (FS) model piece by piece, demonstrating how it can be used to compute match probabilities. In this article, we assume parameters of the model are known. \n\nA more technical treatment is given in [AP\tEnamorado, T., Fifield, B., & Imai, K. (2019)](https://imai.fas.harvard.edu/research/files/linkage.pdf), which contains a generalised form of the model."])))}function Ka(e){return e(E||(E=(0,je.Z)(["## Objective of the Model\n\nThe input to the FS model is a dataset of pairwise record comparisons.\n\nThe aim of the model is to estimate a 'match probability' for each pairwsie comparison, which quantifies the likelihood the two records  represent the same entity."])))}function Va(e){return e(C||(C=(0,je.Z)(['## Set up\n\nThe FS model can be used to link and/or deduplicate one or more datasests. In what follows, let\'s assume we have two datasets we wish to link:\n\n✨<span style="background-color:yellow">You can edit the records in the tables, and all of the subsequent calculations will update accordingly.</span>✨\n\n### Dataset 1\n\n'])))}function Ga(e){return e}function Ya(e){return e(B||(B=(0,je.Z)(["### Dataset 2"])))}function $a(e){return e}function Qa(e,t){return e(D||(D=(0,je.Z)(["\n\nTo be compatible with the FS model, the input data must be converted into pairwise comparisons as follows:\n\n### Record comparisons\n\n","\n<br>\nThis table compares every row in dataset 1 to every row in dataset 2.  \n"])),t.view())}function Xa(e,t,a,n,r,o){return e(I||(I=(0,je.Z)(["## Comparing columns\n\nWe need a mathematical way of evaluating these pairwise comparisons - a function that takes the comparisons as an input, and outputs match probabilities.  \n\nThe FS model solves this problem by comparing the records column by column, and assigning each comparison to two or more 'similarity levels'.\n\nA simple example of a two-level comparison rule for a column may be:\n\n- If the values in the column exactly match, assign the comparison to similarity level 1\n- Otherwise assign the comparison to similarity level 0\n\nIn the following table, we apply this simple rule to every column. The comparisons are denoted with the prefix `𝛾_` because the mathematical symbol gamma is often used in the literate to represent comparisons.\n\n","\n\n<br>\n\nNow that we have a numeric representation of the comparisons, the model makes no further use of the raw data, instead using only the values in the 𝛾 columns: \n\n","   \n<br>\nFor each row in this table, the set of gamma values is known as the 'comparison vector'.  For example, the comparison vector for the first row in the table is:\n\n","\n "],["## Comparing columns\n\nWe need a mathematical way of evaluating these pairwise comparisons - a function that takes the comparisons as an input, and outputs match probabilities.  \n\nThe FS model solves this problem by comparing the records column by column, and assigning each comparison to two or more 'similarity levels'.\n\nA simple example of a two-level comparison rule for a column may be:\n\n- If the values in the column exactly match, assign the comparison to similarity level 1\n- Otherwise assign the comparison to similarity level 0\n\nIn the following table, we apply this simple rule to every column. The comparisons are denoted with the prefix \\`𝛾_\\` because the mathematical symbol gamma is often used in the literate to represent comparisons.\n\n","\n\n<br>\n\nNow that we have a numeric representation of the comparisons, the model makes no further use of the raw data, instead using only the values in the 𝛾 columns: \n\n","   \n<br>\nFor each row in this table, the set of gamma values is known as the 'comparison vector'.  For example, the comparison vector for the first row in the table is:\n\n","\n "])),t.view(),a.view(),n(W||(W=(0,je.Z)(["",""])),r(t.slice(0,1).objects()[0],o)))}function en(e){return e(R||(R=(0,je.Z)(["## Scoring comparisons"])))}function tn(e){return e(J||(J=(0,je.Z)(["We now need a way of recombining these individual column comparisons into an overall match probability.  \n\nWe will want this approach to account for the differing importance of columns.  For example, a match on gender is less informative than a match on date of birth.\n\nThe FS model approaches this problem by estimating match weights for each individual column and combining these match weights.  \n\nBy assuming mutual independence of the features, each column can be accounted for separately, dramatically simplifying the maths.  \n\nIn particular, this assumption makes the model equivalent to a [Naïve Bayes](https://en.wikipedia.org/wiki/Naive_Bayes_classifier) classifier.  This allows the match probability to be expressed as a repeated multiplication of conditional probabilities. Further mathmetical details can be found [here](https://en.wikipedia.org/wiki/Naive_Bayes_classifier#Probabilistic_model).\n\nIn our case, 'mutual independence of features' means that linkage variables must be independent given the match status.  \n\nThis would be violated if amongst matching records, a typo on first name was correlated with a typo on surname.  Another  violation often occurs with addresses if they are separated into multiple columns: Amongst matching records, a match on postcode typically implies a match on town.  \n\nTo further understand how we account for each comparison column in the computation of match probability, we need to introduce the concept of `m` and `u` probabilities.\n"],["We now need a way of recombining these individual column comparisons into an overall match probability.  \n\nWe will want this approach to account for the differing importance of columns.  For example, a match on gender is less informative than a match on date of birth.\n\nThe FS model approaches this problem by estimating match weights for each individual column and combining these match weights.  \n\nBy assuming mutual independence of the features, each column can be accounted for separately, dramatically simplifying the maths.  \n\nIn particular, this assumption makes the model equivalent to a [Naïve Bayes](https://en.wikipedia.org/wiki/Naive_Bayes_classifier) classifier.  This allows the match probability to be expressed as a repeated multiplication of conditional probabilities. Further mathmetical details can be found [here](https://en.wikipedia.org/wiki/Naive_Bayes_classifier#Probabilistic_model).\n\nIn our case, 'mutual independence of features' means that linkage variables must be independent given the match status.  \n\nThis would be violated if amongst matching records, a typo on first name was correlated with a typo on surname.  Another  violation often occurs with addresses if they are separated into multiple columns: Amongst matching records, a match on postcode typically implies a match on town.  \n\nTo further understand how we account for each comparison column in the computation of match probability, we need to introduce the concept of \\`m\\` and \\`u\\` probabilities.\n"])))}function an(e,t){return e(L||(L=(0,je.Z)(["### m and u probabilities \n\nHow much should we increase our estimate of match probability if we observe a match on first name? How about a match on gender? And what about if we observe a mismatch on these fields?  \n\nWe are interested in evaluating statements like: \n\n"," \n\nThis can be quantified using the m and u probabilities for each column, combined with Bayes Theorem (see annex for a refresher).\n\nConsider the first name column.  We have defined two similarity levels:  level 1 if the first name exactly matches, and level 0 otherwise.\n\n#### m probabilities\nThe m probabilities for the first name column are:\n\n","\n\n\n","\n\n\nThat is, amongst record comparisons which are true matches, what proportion have a match on first name, and what proportion mismatch on first name?\n\nThis is a measure of how often mispellings, nicknames or aliases occur in the first name field.\n\n#### u probabilities\n\nThe u probabilities for the first name column are:\n\n","\n\n\n","\n\n\n\nThat is, amongst record comparisons which are true non-matches, what proportion have a match on first name, and what proportion mismatch on first name?\n\nThis is a measure of how likely 'collisions' are likely to occur. For instance, it would be common for two different people to have the same gender, but less likely for two different people to have the same date of birth.\n\n#### The overall proportion of matches\n\nLet us also define:\n\n"," \n\nThis is our prior - our estimate for the probability that a randomly-chosen pairwise record comparison is a match.\n\n### Bayes Theorem\n\nWe can now use Bayes Theorem  to write:\n\n","\n\nwhich, in our notation is:\n\n","\n\n\n"])),t(M||(M=(0,je.Z)(["operatorname{Pr}(\text{records match}|\text{first name matches})"],["\\operatorname{Pr}(\\text{records match}|\\text{first name matches})"]))),t(N||(N=(0,je.Z)(["m_\text{first name,level_0} = operatorname{Pr}(\text{first name does not match}|\text{record match})"],["m_\\text{first name,level\\_0} = \\operatorname{Pr}(\\text{first name does not match}|\\text{record match})"]))),t(z||(z=(0,je.Z)(["m_\text{first name, level_1} = operatorname{Pr}(\text{first name matches}|\text{records match})"],["m_\\text{first name, level\\_1} = \\operatorname{Pr}(\\text{first name matches}|\\text{records match})"]))),t(H||(H=(0,je.Z)(["u_\text{first name, level_0} = operatorname{Pr}(\text{first name does not match}|\text{records do not match})"],["u_\\text{first name, level\\_0} = \\operatorname{Pr}(\\text{first name does not match}|\\text{records do not match})"]))),t(U||(U=(0,je.Z)(["u_\text{first name, level_1} = operatorname{Pr}(\text{first name matches}|\text{records do not match})"],["u_\\text{first name, level\\_1} = \\operatorname{Pr}(\\text{first name matches}|\\text{records do not match})"]))),t(K||(K=(0,je.Z)(["operatorname{Pr}(\text{records match}) = lambda"],["\\operatorname{Pr}(\\text{records match}) = \\lambda"]))),t(V||(V=(0,je.Z)(["\n\text{posterior} = operatorname{Pr}(\text{records match}|\text{first name matches}) \newline [10pt] = \frac{operatorname{Pr}(\text{first name matches}|\text{records match})operatorname{Pr}(\text{records match})}{operatorname{Pr}{(\text{first name matches})}}"],["\n\\text{posterior} = \\operatorname{Pr}(\\text{records match}|\\text{first name matches}) \\newline [10pt] = \\frac{\\operatorname{Pr}(\\text{first name matches}|\\text{records match})\\operatorname{Pr}(\\text{records match})}{\\operatorname{Pr}{(\\text{first name matches})}}"]))),t(G||(G=(0,je.Z)(["\n\text{posterior} = operatorname{Pr}(\text{records match}|\text{first name matches}) \newline [10pt] = \frac{m_\text{first name, level_1}lambda}{m_\text{first name, level_1}lambda + u_\text{first name, level_1}(1-lambda)}"],["\n\\text{posterior} = \\operatorname{Pr}(\\text{records match}|\\text{first name matches}) \\newline [10pt] = \\frac{m_\\text{first name, level\\_1}\\lambda}{m_\\text{first name, level\\_1}\\lambda + u_\\text{first name, level\\_1}(1-\\lambda)}"]))))}function nn(e,t,a){return e(Y||(Y=(0,je.Z)(["We can generalise this formula by using  "," to indicate the value of the comparison, the index "," to designate the comparison column, and "," to designate the observed comparison level, we can write:\n\n","\n\nFinally, by assuming conditional independence among linkage variables given the match status, we can account for more than one comparison column.  For instance, in the case of two comparison columns\n\n","\n\nLeading to the following formula that takes into account all column comparisons:\n\n#### Equation 1:\n","\n\n\nThis equation provides the output of the Fellegi Sunter model - an estimate of the probability that two records match given the information contained\n\n"])),t($||($=(0,je.Z)(["gamma"],["\\gamma"]))),t(Q||(Q=(0,je.Z)(["k"]))),t(X||(X=(0,je.Z)(["ell"],["\\ell"]))),a(ee||(ee=(0,je.Z)(["\n\text{posterior} = operatorname{Pr}(\text{records match}|gamma_{k}) \newline [10pt] = \frac{lambda m_{kell}}{lambda m_{kell}+ u_{kell}(1-lambda)}"],["\n\\text{posterior} = \\operatorname{Pr}(\\text{records match}|\\gamma_{k}) \\newline [10pt] = \\frac{\\lambda m_{k\\ell}}{\\lambda m_{k\\ell}+ u_{k\\ell}(1-\\lambda)}"]))),a(te||(te=(0,je.Z)(["\noperatorname{Pr}(\text{records match}|gamma_{1},gamma_{2}) \newline [10pt] = \frac{operatorname{Pr}(gamma_{1}|\text{records match})operatorname{Pr}(gamma_{2}|\text{records match})operatorname{Pr}(\text{records match})}{operatorname{Pr}{(gamma_{1},gamma_{2})}}"],["\n\\operatorname{Pr}(\\text{records match}|\\gamma_{1},\\gamma_{2}) \\newline [10pt] = \\frac{\\operatorname{Pr}(\\gamma_{1}|\\text{records match})\\operatorname{Pr}(\\gamma_{2}|\\text{records match})\\operatorname{Pr}(\\text{records match})}{\\operatorname{Pr}{(\\gamma_{1},\\gamma_{2})}}"]))),a(ae||(ae=(0,je.Z)(["\noperatorname{Pr}(\text{records match}|gamma_{1},gamma_{2},ldots,gamma_{K})  \newline [10pt] = \frac{lambda m_{1ell}m_{2ell}ldots m_{Kell}}{lambda m_{1ell}m_{2ell}ldots m_{Kell}+ (1-lambda)u_{1ell}u_{1ell} ldots u_{Kell}} "],["\n\\operatorname{Pr}(\\text{records match}|\\gamma_{1},\\gamma_{2},\\ldots,\\gamma_{K})  \\newline [10pt] = \\frac{\\lambda m_{1\\ell}m_{2\\ell}\\ldots m_{K\\ell}}{\\lambda m_{1\\ell}m_{2\\ell}\\ldots m_{K\\ell}+ (1-\\lambda)u_{1\\ell}u_{1\\ell} \\ldots u_{K\\ell}} "]))))}function rn(e){return e(ne||(ne=(0,je.Z)(["In subsequent articles, we use the concepts of m and u probabilities to discuss the intuition behind match weights, and present graphical ways of interpreting the values.  \n\nWe finish this article with a worked example of the probability calculation."])))}function on(e){return e(re||(re=(0,je.Z)(["## Example"])))}function sn(e){return e(oe||(oe=(0,je.Z)(['\nIn order to present an example calculation we need to choose values for the parameters of the model - the m and u values.\n\nWe can represent the m and u values for a comparison column succinctly as follows:\n\n```\n{\n  "col_name": "fname",\n  "m_probabilities": [0.2,0.8],\n  "u_probabilities": [0.9,0.1],\n}\n```\n\nThe position (index) of the arrays corresponds to the comparison level.  \n\nFor example, `"m_probabilities": [0.2,0.8]` means that amongst matching records, 20% have a disagreement on the first name (e.g. "John" vs. "Jonathan"), and 80% match (e.g. "David" vs. "David")\n\nUsing this notation, parameters we will choose for our model are as follows.  ✨<span style="background-color:yellow">You may edit these values to see how they affect the calculation.</span>✨\n\n'],['\nIn order to present an example calculation we need to choose values for the parameters of the model - the m and u values.\n\nWe can represent the m and u values for a comparison column succinctly as follows:\n\n\\`\\`\\`\n{\n  "col_name": "fname",\n  "m_probabilities": [0.2,0.8],\n  "u_probabilities": [0.9,0.1],\n}\n\\`\\`\\`\n\nThe position (index) of the arrays corresponds to the comparison level.  \n\nFor example, \\`"m_probabilities": [0.2,0.8]\\` means that amongst matching records, 20% have a disagreement on the first name (e.g. "John" vs. "Jonathan"), and 80% match (e.g. "David" vs. "David")\n\nUsing this notation, parameters we will choose for our model are as follows.  ✨<span style="background-color:yellow">You may edit these values to see how they affect the calculation.</span>✨\n\n'])))}function ln(e,t){return e.textarea({value:t,rows:26,spellcheck:!1})}function mn(e){return e(ie||(ie=(0,je.Z)(['We will now present a worked example of the calculation of match probability for the following pairwise record comparison.  \n\n\n✨<span style="background-color:yellow">You may change the record comparison using the control below</span>✨\n'])))}function cn(e,t){return e.range([1,t.numRows()],{value:1,label:"Choose record comparison",step:1})}function un(e,t,a){return e(se||(se=(0,je.Z)(["",""])),t.slice(a-1,a).toMarkdown())}function _n(e,t,a,n,r,o){return e(le||(le=(0,je.Z)(["The comparison vector is given by:\n\n","\n\n"])),t(me||(me=(0,je.Z)(["",""])),a(n.slice(r-1,r).objects()[0],o)))}function dn(e){return e(ce||(ce=(0,je.Z)(["The formula for match probability is:"])))}function fn(e,t,a,n,r){return e(ue||(ue=(0,je.Z)(["",""])),t(a.slice(n-1,n).objects()[0],r))}function pn(e){return e(_e||(_e=(0,je.Z)(["And substituting in numbers using our specified parameters we get: "])))}function bn(e,t,a,n,r){return e(de||(de=(0,je.Z)(["",""])),t(a.slice(n-1,n).objects()[0],r))}function hn(e,t,a,n,r,o){return e(fe||(fe=(0,je.Z)(["i.e. the ","\n\n"])),t(pe||(pe=(0,je.Z)(["\text{estimated match probability} = \n\n","\n\n"],["\\text{estimated match probability} = \n\n","\n\n"])),a(n.slice(r-1,r).objects()[0],o).match_probability.toPrecision(4)))}function vn(e){return e(be||(be=(0,je.Z)(["<br><br>"])))}function gn(e,t,a){return e(he||(he=(0,je.Z)(["## Annex:  Bayes Theorem\n\nRecall that Bayes Theorem is given by:\n\n"," \n\n\nor , in words: \n\n","\n\nIn the context of record linkage, we can describe these parts as:\n\n**Prior**:\nThe overall proportion of comparisons which are matches ",".\n\n**Evidence**: We have observed that e.g. first name matches, ",".\n\n**Likelihood**: The probability that first name matches amongst matches, given by ",".  \n\nSo Bayes' formuls is:\n\n","\n\nWhich can also be written:\n\n","\n\ngiving us:\n\n","\n\nWhich is the same as Equation 1.\n"])),t(ve||(ve=(0,je.Z)(["\noperatorname{Pr}(a|b) = {\frac{operatorname{Pr}(b|a)operatorname{Pr}(a)}{operatorname{Pr}{(b)}}}"],["\n\\operatorname{Pr}(a|b) = {\\frac{\\operatorname{Pr}(b|a)\\operatorname{Pr}(a)}{\\operatorname{Pr}{(b)}}}"]))),t(ge||(ge=(0,je.Z)(["\n\text{posterior} = \frac{\text{likelihood} \times \text{prior}}{\text{evidence}}"],["\n\\text{posterior} = \\frac{\\text{likelihood} \\times \\text{prior}}{\\text{evidence}}"]))),a(ye||(ye=(0,je.Z)(["operatorname{Pr}(\text{match})"],["\\operatorname{Pr}(\\text{match})"]))),a(we||(we=(0,je.Z)(["operatorname{Pr}(\text{first name matches})"],["\\operatorname{Pr}(\\text{first name matches})"]))),a(xe||(xe=(0,je.Z)(["operatorname{Pr}(\text{first name matches}|\text{records match})"],["\\operatorname{Pr}(\\text{first name matches}|\\text{records match})"]))),t(ke||(ke=(0,je.Z)(["\noperatorname{Pr}(\text{match}|\text{first name matches}) = \frac{operatorname{Pr}(\text{first name matches}|\text{match})operatorname{Pr}(\text{match})}{operatorname{Pr}{(\text{first name matches})}}"],["\n\\operatorname{Pr}(\\text{match}|\\text{first name matches}) = \\frac{\\operatorname{Pr}(\\text{first name matches}|\\text{match})\\operatorname{Pr}(\\text{match})}{\\operatorname{Pr}{(\\text{first name matches})}}"]))),t(Pe||(Pe=(0,je.Z)([" \n\frac{operatorname{Pr}(\text{first name matches}|\text{match})operatorname{Pr}(\text{match})}{operatorname{Pr}(\text{first name matches}|\text{match})operatorname{Pr}(\text{match}) + operatorname{Pr}(\text{first name matches}|\text{non match})operatorname{Pr}(\text{non match})}"],[" \n\\frac{\\operatorname{Pr}(\\text{first name matches}|\\text{match})\\operatorname{Pr}(\\text{match})}{\\operatorname{Pr}(\\text{first name matches}|\\text{match})\\operatorname{Pr}(\\text{match}) + \\operatorname{Pr}(\\text{first name matches}|\\text{non match})\\operatorname{Pr}(\\text{non match})}"]))),t(Ze||(Ze=(0,je.Z)(["\noperatorname{Pr}(\text{match}|\text{first name matches}) = \n\frac{m_1lambda}{m_1lambda + u_1(1-lambda)}"],["\n\\operatorname{Pr}(\\text{match}|\\text{first name matches}) = \n\\frac{m_1\\lambda}{m_1\\lambda + u_1(1-\\lambda)}"]))))}function yn(e){return e(qe||(qe=(0,je.Z)(["## Calculations and code"])))}function wn(e){return e.options({displayMode:!0,fleqn:!0})}function xn(){return'{\n    "proportion_of_matches": 0.01,\n    "comparison_columns": [\n      {\n        "col_name": "fname",\n        "u_probabilities": [0.8, 0.2],\n        "m_probabilities": [0.2, 0.8]\n      },\n      {\n        "col_name": "sname",\n        "u_probabilities": [0.9, 0.1],\n        "m_probabilities": [0.2, 0.8]\n      },\n      {\n        "col_name": "dob",\n        "u_probabilities": [0.99, 0.01],\n        "m_probabilities": [0.2, 0.8]\n      },\n      {\n        "col_name": "town",\n        "u_probabilities": [0.7, 0.3],\n        "m_probabilities": [0.3, 0.7]\n      }\n    ]\n  \n  }'}function kn(e){return JSON.parse(e)}function Pn(e){return e(Te||(Te=(0,je.Z)(["<style>\n.katex-display>.katex { font-size: 1em}\n.katex-display>.katex>.katex-html>.tag {right: unset; padding-left:4em}\ntextarea {\n    max-height: 1000em !important;\n    font-family: monospace !important;\n}\n</style>"])))}function Zn(e){return e("@observablehq/inputs")}function qn(e,t){var a=e.module();a.variable(t("title")).define("title",["md"],za),a.variable(t()).define(["md"],Ha),a.variable(t("para_1")).define("para_1",["md"],Ua),a.variable(t("para_2")).define("para_2",["md"],Ka),a.variable(t("para_3")).define("para_3",["md"],Va),a.variable(t("table_l1")).define("table_l1",["table_l"],Ga),a.variable(t("ds2_head")).define("ds2_head",["md"],Ya),a.variable(t("table_r1")).define("table_r1",["table_r"],$a),a.variable(t("rec_comparisons")).define("rec_comparisons",["md","df_comparisons_1"],Qa),a.variable(t("para_4")).define("para_4",["md","df_gammas_1","df_gammas_only_1","texd","get_comparison_vector_symbols_and_numbers","settings"],Xa),a.variable(t("subhead_1")).define("subhead_1",["md"],en),a.variable(t("para_5")).define("para_5",["md"],tn),a.variable(t("para_6")).define("para_6",["md","texd"],an),a.variable(t("para_7")).define("para_7",["md","tex","texd"],nn),a.variable(t("para_8")).define("para_8",["md"],rn),a.variable(t("subhead_2")).define("subhead_2",["md"],on),a.variable(t("para_10")).define("para_10",["md"],sn),a.variable(t("viewof splink_settings")).define("viewof splink_settings",["inputs","default_splink_settings"],ln),a.variable(t("splink_settings")).define("splink_settings",["Generators","viewof splink_settings"],(function(e,t){return e.input(t)})),a.variable(t("para_11")).define("para_11",["md"],mn),a.variable(t("viewof row_index")).define("viewof row_index",["inputs","df_gammas_1"],cn),a.variable(t("row_index")).define("row_index",["Generators","viewof row_index"],(function(e,t){return e.input(t)})),a.variable(t("this_row")).define("this_row",["md","df_comparisons_1","row_index"],un),a.variable(t("para_12")).define("para_12",["md","texd","get_comparison_vector_symbols_and_numbers","df_gammas_1","row_index","settings"],_n),a.variable(t("para_13")).define("para_13",["md"],dn),a.variable(t("para_14")).define("para_14",["texd","get_m_u_formula_symbols","df_gammas_1","row_index","settings"],fn),a.variable(t("para_15")).define("para_15",["md"],pn),a.variable(t("para_16")).define("para_16",["texd","get_m_u_formula_numbers","df_gammas_1","row_index","settings"],bn),a.variable(t("para_17")).define("para_17",["md","tex","get_match_probability_components","df_gammas_1","row_index","settings"],hn),a.variable(t("para_18")).define("para_18",["md"],vn),a.variable(t("para_19")).define("para_19",["md","texd","tex"],gn),a.variable(t()).define(["md"],yn);var n=e.module(Na);a.import("example_2_comparison",n),a.import("intro_simple_waterfall",n),a.import("table_l",n),a.import("table_r",n),a.import("df_1_l",n),a.import("df_1_r",n),a.import("df_comparisons_1",n),a.import("df_gammas_1",n),a.import("df_gammas_only_1",n);var r=e.module(ha);return a.import("get_m_u_formula_symbols",r),a.import("get_m_u_formula_numbers",r),a.import("get_comparison_vector_symbols_and_numbers",r),a.import("get_match_probability_components",r),a.variable(t("texd")).define("texd",["tex"],wn),a.variable(t("default_splink_settings")).define("default_splink_settings",xn),a.variable(t("settings")).define("settings",["splink_settings"],kn),a.variable(t("css_styles")).define("css_styles",["html"],Pn),a.variable(t("inputs")).define("inputs",["require"],Zn),a}var Tn=a(1369),jn=a(674);var Sn={title:"The mathematics of the Fellegi Sunter model",post_date:"2021-05-07",code_url:"https://observablehq.com/@robinl/86fc30325e4106c4",post_type:"obs",post_category:"probabilistic_linkage",description:"An set of interactive, explorable explanations of the Fellegi Sunter model of probabilistic record linkage.  This article presents the maths alongside an interactive example."},On=["title","para_1","para_2","para_3","table_l1","ds2_head","table_r1","rec_comparisons","para_4","subhead_1","para_5","para_6","para_7","para_8","subhead_2","para_10","viewof splink_settings","para_11","viewof row_index","this_row","para_12","para_13","para_14","para_15","para_16","para_17","para_18","para_19","css_styles"],Fn={name:"147cmx0",styles:"margin-left:auto;margin-right:auto;width:90%;max-width:800px;table{font-size:0.8rem;line-height:1rem;}rem;"},An=function(e){return(0,jn.tZ)(Tn.Z,{define:qn,output_order:On,post_frontmatter:Sn,css:Fn,current_path:e.path})}}}]);
//# sourceMappingURL=component---src-pages-maths-of-fellegi-sunter-jsx-c11ee89ea5c7a0d86213.js.map